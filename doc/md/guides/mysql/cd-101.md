---
id: mysql-cd-101
title: Detecting drops of foreign key constraints on MySQL
slug: /guides/mysql/checks/CD101
tags: [linting, ci, destructive-change, mysql, drop-foreign-key]
---

## Introduction

This document describes in detail the detection of dropping foreign keys in MySQL databases, 
using Atlas's linting capabilities.

A foreign key constraint can be dropped from a table using the following command:
```sql
ALTER TABLE pets DROP FOREIGN KEY owner_id;
```

Even though this action does not cause data loss and there may be good reasons to perform it on a production database, it can have negative and sometimes unpredictable side effects which should be taken into consideration.
Atlas's linter can be used to raise a flag when a foreign key drop is about to be executed. Simply run:
```bash
atlas migrate lint --dir file://migrations --dev-url "mysql://root:pass@localhost:3306/dev" --latest 1
```
The `--latest` flag tells Atlas to analyze only the last migration file. If the file contains a foreign key drop, the output will be something like:

```bash
20230305125128.sql: constraint deletion detected:

	L1: Dropping foreign-key constraint "owner_id"
```

[Click here](/versioned/lint) for more information about how to use the Atlas Linter.

## Impact of dropping foreign key constraints

### Data integrity
Like mentioned above, a foreign key drop is not a destructive action, meaning it's not causing data loss. But it does impact the **integrity** of the data. In other words, this action won't change the data in the table, but it will change the way different tables interact with one another.

Suppose we have the following database:
<p style={{textAlign: "center"}}><a href="https://gh.atlasgo.cloud/explore/1b14810d"><img src="https://atlasgo.io/uploads/users-pets.png" alt="Pets ERD"/></a></p>

 And we drop the foreign key between `pets` and `users` with the following command: 

```sql
ALTER TABLE pets DROP FOREIGN KEY owner_fk;
```

Now, inserting data into the `pets` table is still possible, however it is also possible to insert "invalid" data. For example, assuming the `users` table is empty, the following command will not fail:

```sql
INSERT INTO pets (name, owner_id) VALUES ('Fortuna', 1);
```

Let's see an example where this can have impact on the system. The following `JOIN` query can return empty if the pets it queries has a "fake" owner:
```sql
SELECT
    pets.name,
    users.name AS owner_name
FROM pets JOIN users ON pets.owner_id = users.id
WHERE pets.name = SOME_PET_NAME;
```
So after dropping the constraint, any code that executes this query and doesn't check if the output is empty can suddenly fail.

### Irreversible changes
Dropping a foreign key constraint is not always a reversible operation. If "invalid" data exists in the table, which otherwise would have been blocked by the constraint, then the foreign key cannot be re-applied until this data is altered or deleted.

Following the previous example, trying to recreate the constraint will fail:
```sql
ALTER TABLE pets ADD CONSTRAINT owner_id FOREIGN KEY (owner_id) REFERENCES users (id);
// highlight-next-line-error-message
Cannot add or update a child row: a foreign key constraint fails (`pets`.`#sql-1_1140`, CONSTRAINT `owner_id` FOREIGN KEY (`owner_id`) REFERENCES `users` (`id`))
```

The only way the constraint can be applied again is by deleting all the invalid rows:
```sql
DELETE FROM pets WHERE name='Fortuna';
```
After running the last command, we will be able to successfully add the constraint again.

### Cascading
Cascading policies on foreign keys may be used for various reasons. For example, a cascading deletion policy can help save storage space by automatically cleaning irrelevant ("orphan") data. Another example: organizations are often legally obliged to delete all the data related to a deleted user. This is commonly achieved with deletion cascading policies.  
Dropping a foreign key constraint also cancels all cascading policies, and thus can cause unwanted behaviors as side effects of the constraint drop itself.

## Prevention

Preventing accidental constraint drops is easy with Atlas's [`migrate lint`](/versioned/lint)
command. With the `atlas migrate lint` command, users can analyze the migration directory to 
detect potentially dangerous changes to the database schema. This command may be 
incorporated in continuous integration pipelines to enable teams to enforce 
desired policies with regard to schema changes.

When using `migrate lint` to analyze migrations, users must supply multiple parameters:

* `--dev-url` - a URL to a [dev database](/concepts/dev-database) that will be used to simulate the changes and verify their correctness.
* `--dir` - the URL of the migration directory, by default it is file://migrations, e.g a directory named migrations in the current working directory.
